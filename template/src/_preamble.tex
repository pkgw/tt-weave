\documentclass{tdux}

% plain/webmac compatibility

\countdef\pageno=0
\def\contentspagenumber{0}
\def\item{\par}
\def\yskip{}

% left-arrow allusion in WEAVE.WEB
\catcode`\^^X=\active
\def^^X{‚Üê}

% up-arrow allusion in WEAVE.WEB
\catcode`\^^K=\active
\def^^K{(up-arrow)}

% WEAVE.WEB: `\.^^Z\ `
\catcode`\^^Z=\active
\def^^Z{\^\^Z}

\makeatletter
\def\eqalign#1{\null\,\vcenter{\openup\jot\m@th
  \ialign{\strut\hfil$\displaystyle{##}$&$\displaystyle{{}##}$\hfil
      \crcr#1\crcr}}\,}
\makeatother

\let\justTeX=\TeX
\def\TeX{\special{tdux:cs math}\justTeX\special{tdux:ce math}}

% tt-weave commands

\newif\iffirstmodule
\firstmoduletrue

\newcommand{\WebMajorModule}[1]{%
  \newpage\par
  \iffirstmodule
    \firstmodulefalse
    \special{tdux:mfs section^^J%
Cttweave-first}
  \else
    \special{tdux:me section}
    \special{tdux:mfs section^^J%
Cttweave-nonfirst}
  \fi
  \textbf{#1.}
}
\let\WebMinorModule=\WebMajorModule

\newenvironment{WebPrettifiedDisplay}{%
  \par % If in hmode, get into vmode
  \ifmmode\else\ttfamily\fi
  \special{tdux:mfs pre^^J%
NAT^^J%
NAS}\special{tdux:mfs code}%
}{
  \par % Get back into vmode if we were in hmode (and so emit any </p>s)
  \special{tdux:me code}\special{tdux:me pre}%
  \ifmmode\else\rmfamily\fi
}

\newenvironment{WebPrettifiedInline}{%
  \ifmmode\else\ttfamily\fi
  \special{tdux:mfs code^^J%
NAT^^J%
NAS}%
}{
  \special{tdux:me code}%
  \ifmmode\else\rmfamily\fi
}

% I find octal literals super annoying to read, so
% let's just display them all as hex
\newcommand{\WebOctalLiteralHexed}[1]{0x#1}
\newcommand{\WebHexLiteral}[1]{0x#1}

% {foreground-color}{background-color}{font-options}{text}
% todo ignoring font options
\newcommand{\WebPrettifiedCodeSpan}[4]{%
  \special{tdux:mfs span^^J%
Scolor #1^^J%
Sbackground-color #2^^J%
}#4\special{tdux:me span}%
}
\let\S=\WebPrettifiedCodeSpan

% Space for <pre> sections -- if we're indenting, consecutive spaces matter,
% so we can't just rely on TeX to emit them correctly.
\newcommand{\WebSp}{ \special{tdux:dt \space}}
\let\ =\WebSp

% Newline for <pre> sections -- need to insert an actual newline into the HTML
% content, which we can do with `dt` (Direct Text).
\newcommand{\WebNL}{\special{tdux:dt ^^J}}

% Ready to go!

\begin{document}

% Plain TeX definitions that could cause problems for LaTeX if we did them
% earlier:
\def\.#1{\texttt{#1}}
\def\'{\textquotesingle}
\def\~{\texttildelow}
\def\\{\textbackslash}
\def\^{\char94\relax}
